# gera os blocos do uf2


import struct
import os
import sys


def rp2040_crc32(data):
    crc = 0xFFFFFFFF
    for byte in data:
        crc ^= (byte << 24)
        for _ in range(8):
            if crc & 0x80000000:
                crc = (crc << 1) ^ 0x04C11DB7
            else:
                crc = crc << 1
    return crc & 0xFFFFFFFF

def make_uf2(bin_filename, uf2_filename):
    print(f"[*] Processando: {bin_filename} -> {uf2_filename}")

    RP2040_FAMILY_ID = 0xe48bff56
    FLASH_START = 0x10000000 
    PAGE_SIZE = 256
    UF2_MAGIC_START0 = 0x0A324655
    UF2_MAGIC_START1 = 0x9E5D5157
    UF2_MAGIC_END = 0x0AB16F30
    FLAG_FAMILY_ID_PRESENT = 0x00002000

    BOOT2_DATA = bytes([
        0x00, 0xb5, 0x32, 0x4b, 0x21, 0x20, 0x58, 0x60, 0x98, 0x68, 0x02, 0x21,
        0x88, 0x43, 0x98, 0x60, 0xd8, 0x60, 0x18, 0x61, 0x58, 0x61, 0x2e, 0x4b,
        0x00, 0x21, 0x99, 0x60, 0x02, 0x21, 0x59, 0x61, 0x01, 0x21, 0xf0, 0x22,
        0x99, 0x50, 0x2b, 0x49, 0x19, 0x60, 0x01, 0x21, 0x99, 0x60, 0x35, 0x20,
        0x00, 0xf0, 0x44, 0xf8, 0x01, 0x22, 0x1a, 0x60, 0x25, 0x20, 0x00, 0xf0,
        0x3f, 0xf8, 0x1a, 0x60, 0x01, 0x21, 0x19, 0x60, 0x00, 0x21, 0x99, 0x60,
        0x20, 0x4b, 0x1a, 0x60, 0x03, 0x21, 0x99, 0x60, 0x1d, 0x48, 0x03, 0x68,
        0x03, 0x4b, 0x98, 0x42, 0x05, 0xd0, 0x00, 0x21, 0x99, 0x60, 0x1b, 0x49,
        0x0b, 0x60, 0x06, 0xe0, 0x99, 0x60, 0x18, 0x48, 0x00, 0x68, 0x01, 0x21,
        0x08, 0x42, 0xf8, 0xd1, 0x17, 0x49, 0x08, 0x60, 0x17, 0x49, 0x0c, 0x60,
        0x17, 0x49, 0x08, 0x60, 0x17, 0x49, 0x0c, 0x60, 0x17, 0x49, 0x08, 0x60,
        0x07, 0x20, 0x00, 0xf0, 0x0f, 0xf8, 0x00, 0x23, 0x00, 0x22, 0x9f, 0x42,
        0x29, 0xd3, 0x13, 0x4a, 0x11, 0x60, 0x23, 0x70, 0x11, 0x60, 0x23, 0x70,
        0x11, 0x60, 0x03, 0x22, 0x11, 0x60, 0x23, 0x70, 0x11, 0x60, 0x23, 0x70,
        0x11, 0x60, 0x00, 0x22, 0x11, 0x60, 0x23, 0x70, 0x11, 0x60, 0x23, 0x70,
        0x11, 0x60, 0x1b, 0x70, 0x1b, 0x70, 0x1b, 0x70, 0x1b, 0x70, 0x1b, 0x70,
        0x1b, 0x70, 0x0b, 0x49, 0x0b, 0x60, 0x00, 0x20, 0x00, 0xf0, 0x2b, 0xf8,
        0x01, 0x22, 0x1a, 0x60, 0x00, 0x22, 0x1a, 0x60, 0x00, 0x20, 0x00, 0xf0,
        0x24, 0xf8, 0x00, 0x21, 0x99, 0x60, 0x1a, 0x60, 0x00, 0xbe, 0x00, 0x00,
        0x18, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x02, 0x40, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x01, 0x40
    ])

    boot2_padded = BOOT2_DATA.ljust(252, b'\x00')
    checksum = rp2040_crc32(boot2_padded)
    boot2_final = boot2_padded + struct.pack("<I", checksum)
    print(f"[*] Boot2 CRC32 calculado: {hex(checksum)}")

    if not os.path.exists(bin_filename):
        print(f"[!] Erro: Arquivo '{bin_filename}' nÃ£o encontrado.")
        sys.exit(1)
        
    with open(bin_filename, "rb") as f:
        user_code = f.read()

    full_image = boot2_final + user_code
    
    padding_needed = (PAGE_SIZE - (len(full_image) % PAGE_SIZE)) % PAGE_SIZE
    full_image += b'\x00' * padding_needed

    num_blocks = len(full_image) // PAGE_SIZE
    print(f"[*] Gerando {num_blocks} blocos UF2...")

    with open(uf2_filename, "wb") as f:
        for blockno in range(num_blocks):
            chunk = full_image[blockno * PAGE_SIZE : (blockno + 1) * PAGE_SIZE]
            
            target_addr = FLASH_START + (blockno * PAGE_SIZE)
            
            head = struct.pack(
                "<IIIIIIII",
                UF2_MAGIC_START0,
                UF2_MAGIC_START1,
                FLAG_FAMILY_ID_PRESENT,
                target_addr,
                256, blockno, num_blocks, RP2040_FAMILY_ID
            )
            tail = struct.pack("<I", UF2_MAGIC_END)
            f.write(head + chunk + b'\x00' * 220 + tail)

    print(f"[*] Sucesso! '{uf2_filename}' gerado.")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        if os.path.exists("firmware.bin"):
            make_uf2("firmware.bin", "firmware.uf2")
        else:
            print("Uso: python maker.py <input.bin> <output.uf2>")
    else:
        make_uf2(sys.argv[1], sys.argv[2])